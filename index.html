<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARK - QR Code Attendance Scanner</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=DM+Mono:wght@400;500&family=Fraunces:opsz,wght@9..144,300;400;600;700;900&display=swap" rel="stylesheet">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, limit, serverTimestamp, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBjOBb_CTu83d8Nn5jo9e0ELByCrNstowQ",
            authDomain: "qrcodeattendance-c3ad0.firebaseapp.com",
            projectId: "qrcodeattendance-c3ad0",
            storageBucket: "qrcodeattendance-c3ad0.firebasestorage.app",
            messagingSenderId: "561593729346",
            appId: "1:561593729346:web:b83443038061b1be7c48db"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const attendanceCol = collection(db, "attendance_logs");
        const teachersCol   = collection(db, "teacher_accounts");

        window.remoteAttendanceLogs = [];
        window.remoteTeachers       = [];
        window.attendanceDocIds     = {};
        window.teacherDocIds        = {};

        function dedupeEntries(arr) {
            const map = {};
            arr.forEach(e => {
                const key = `${e.studentID||''}_${e.date||''}_${String(e.time||'')}_${e.action||''}`;
                if (!map[key]) map[key] = e;
            });
            return Object.values(map);
        }

        window.getCombinedLogs = function() {
            const local  = JSON.parse(localStorage.getItem("attendance") || "[]");
            const remote = window.remoteAttendanceLogs || [];
            return dedupeEntries([...remote, ...local]);
        };

        window.saveToFirebase = async (entry) => {
            try { return (await addDoc(attendanceCol, { ...entry, serverTimestamp: serverTimestamp() })).id; }
            catch (e) { console.error("Firebase Error:", e); }
        };
        window.deleteFromFirebase = async (docId) => {
            try { await deleteDoc(doc(db, "attendance_logs", docId)); return true; }
            catch (e) { console.error("Firebase Delete Error:", e); return false; }
        };
        window.saveTeacherToFirebase = async (teacher) => {
            try { return (await addDoc(teachersCol, { ...teacher, serverTimestamp: serverTimestamp() })).id; }
            catch (e) { console.error("Firebase Error:", e); }
        };
        window.deleteTeacherFromFirebase = async (docId) => {
            try { await deleteDoc(doc(db, "teacher_accounts", docId)); return true; }
            catch (e) { console.error("Firebase Delete Error:", e); return false; }
        };

        const q = query(attendanceCol, orderBy("serverTimestamp", "desc"), limit(500));
        onSnapshot(q, (snapshot) => {
            const remoteLogs = [];
            window.attendanceDocIds = {};
            snapshot.forEach((docSnap) => {
                const d = docSnap.data();
                remoteLogs.push({
                    studentID: d.studentID, studentName: d.studentName,
                    studSection: d.studSection, studContact: d.studContact,
                    studPictureUrl: d.studPictureUrl, time: d.time,
                    date: d.date, action: d.action,
                    teacherName: d.teacherName || null,
                    teacherSubject: d.teacherSubject || null,
                    teacherID: d.teacherID || null,
                    serverTimestamp: d.serverTimestamp
                });
                window.attendanceDocIds[`${d.studentID}_${d.date}_${d.time}_${d.action}`] = docSnap.id;
            });
            window.remoteAttendanceLogs = remoteLogs;
            if (window.onAttendanceUpdate) window.onAttendanceUpdate();
        });

        const qTeachers = query(teachersCol);
        onSnapshot(qTeachers, (snapshot) => {
            const teachers = [];
            window.teacherDocIds = {};
            snapshot.forEach((docSnap) => {
                const d = docSnap.data();
                teachers.push({ id: d.id, name: d.name, subject: d.subject, pin: d.pin });
                window.teacherDocIds[d.id] = docSnap.id;
            });
            window.remoteTeachers = teachers;
            if (window.onTeachersUpdate) window.onTeachersUpdate();
        });
    </script>

    <style>
        :root {
            --red: #dc2626;
            --red-dark: #b91c1c;
            --red-light: #ef4444;
            --red-pale: #fef2f2;
            --red-soft: #fee2e2;
            --red-mid: #fca5a5;
            --red-glow: rgba(220,38,38,0.15);

            --bg: #f5f4f0;
            --bg-card: #ffffff;
            --bg-elevated: #fafaf8;
            --bg-hover: #f0ede8;

            --border: #e8e4de;
            --border-mid: #d4cfc8;
            --border-bright: #dc2626;

            --text: #1a1714;
            --text-sub: #44403c;
            --text-muted: #78716c;
            --text-dim: #a8a29e;
            --text-on-red: #ffffff;

            --font-display: 'Fraunces', serif;
            --font-body: 'Outfit', sans-serif;
            --font-mono: 'DM Mono', monospace;

            --radius: 16px;
            --radius-sm: 10px;
            --radius-xs: 6px;

            --shadow: 0 1px 4px rgba(0,0,0,0.06), 0 4px 16px rgba(0,0,0,0.06);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08), 0 8px 32px rgba(0,0,0,0.08);
            --shadow-red: 0 4px 20px rgba(220,38,38,0.18);
        }

        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-body);
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.6;
            padding: 20px;
        }

        /* Subtle paper texture background */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image:
                radial-gradient(ellipse 70% 50% at 0% 0%, rgba(220,38,38,0.04) 0%, transparent 60%),
                radial-gradient(ellipse 50% 40% at 100% 100%, rgba(220,38,38,0.03) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        * { position: relative; z-index: 1; }

        /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
        .header {
            display: flex;
            align-items: center;
            gap: 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 18px 24px;
            margin-bottom: 14px;
            box-shadow: var(--shadow);
        }
		        .logo {
            max-width: 80px;
            height: auto;
            filter: drop-shadow(0 4px 6px rgba(220, 38, 38, 0.3));
        }

        .logo-wrap {
            width: 52px;
            height: 52px;
            background: var(--red);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 900;
            font-family: var(--font-display);
            color: white;
            flex-shrink: 0;
            box-shadow: var(--shadow-red);
        }

        .header-text { flex: 1; }

        .header-title {
            font-family: var(--font-display);
            font-size: clamp(14px, 2.2vw, 19px);
            font-weight: 700;
            color: var(--text);
            letter-spacing: -0.3px;
            line-height: 1.25;
        }

        .header-sub {
            font-size: 11.5px;
            color: var(--text-muted);
            margin-top: 3px;
            font-family: var(--font-mono);
        }

        .live-clock {
            background: var(--red);
            color: white;
            font-family: var(--font-mono);
            font-size: 12px;
            font-weight: 500;
            padding: 6px 14px;
            border-radius: 20px;
            white-space: nowrap;
            box-shadow: var(--shadow-red);
        }

        /* ‚îÄ‚îÄ CONTEXT BAR ‚îÄ‚îÄ */
        .context-bar {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            border: 1px solid #bbf7d0;
            border-radius: var(--radius-sm);
            padding: 11px 16px;
            margin-bottom: 14px;
            display: none;
            align-items: center;
            gap: 12px;
            font-size: 13px;
        }
        .context-bar.visible { display: flex; }

        .context-dot {
            width: 8px; height: 8px;
            background: #16a34a;
            border-radius: 50%;
            flex-shrink: 0;
            animation: pulse-green 2s infinite;
        }

        @keyframes pulse-green {
            0%, 100% { box-shadow: 0 0 0 0 rgba(22,163,74,0.4); }
            50% { box-shadow: 0 0 0 6px rgba(22,163,74,0); }
        }

        .context-name { font-family: var(--font-display); font-weight: 700; color: #15803d; font-size: 14px; }

        .tag-subject {
            background: #dcfce7;
            color: #15803d;
            border: 1px solid #bbf7d0;
            padding: 2px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-family: var(--font-mono);
            font-weight: 500;
        }

        .context-logout {
            margin-left: auto;
            background: none;
            border: 1px solid #bbf7d0;
            color: #15803d;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            font-family: var(--font-body);
            transition: all 0.2s;
            box-shadow: none;
            margin-top: 0;
        }
        .context-logout:hover { background: #15803d; color: white; transform: none; box-shadow: none; }

        /* ‚îÄ‚îÄ NAV TABS ‚îÄ‚îÄ */
        .nav-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 6px;
            flex-wrap: wrap;
            box-shadow: var(--shadow);
        }

        .nav-tab {
            flex: 1;
            min-width: 110px;
            padding: 10px 14px;
            border: 1px solid transparent;
            background: transparent;
            color: var(--text-muted);
            border-radius: var(--radius-sm);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: var(--font-body);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            box-shadow: none;
        }

        .nav-tab:hover { background: var(--bg-hover); color: var(--text); transform: none; box-shadow: none; }
        .nav-tab.active {
            background: var(--red);
            color: white;
            border-color: var(--red-dark);
            box-shadow: var(--shadow-red);
        }
        .nav-tab.active:hover { background: var(--red-dark); transform: none; }

        /* ‚îÄ‚îÄ TAB CONTENT ‚îÄ‚îÄ */
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.25s ease; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(6px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow);
            margin-bottom: 16px;
        }

        .card-title {
            font-family: var(--font-display);
            font-size: 17px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ‚îÄ‚îÄ STATS GRID ‚îÄ‚îÄ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 20px 18px;
            transition: all 0.25s;
            cursor: default;
            box-shadow: var(--shadow);
        }

        .stat-card:hover {
            border-color: var(--red-light);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .stat-icon { font-size: 26px; margin-bottom: 10px; }

        .stat-value {
            font-family: var(--font-display);
            font-size: 36px;
            font-weight: 900;
            color: var(--red);
            line-height: 1;
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 5px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-weight: 600;
        }

        /* ‚îÄ‚îÄ SECTION STATUS ‚îÄ‚îÄ */
        .section-status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .section-status-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 16px;
            transition: all 0.2s;
        }

        .section-status-card:hover { border-color: var(--red-mid); box-shadow: var(--shadow); }

        .section-status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .section-name {
            font-family: var(--font-display);
            font-weight: 700;
            font-size: 14px;
            color: var(--text);
        }

        .section-count-badge {
            background: var(--red-soft);
            color: var(--red);
            font-family: var(--font-mono);
            font-size: 11px;
            font-weight: 500;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .section-stats { display: flex; gap: 12px; }
        .section-stat { flex: 1; text-align: center; }
        .section-stat-val { font-family: var(--font-mono); font-size: 20px; font-weight: 700; }
        .section-stat-val.in { color: #16a34a; }
        .section-stat-val.out { color: var(--red); }
        .section-stat-lbl { font-size: 10px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.8px; }

        .section-progress { margin-top: 10px; height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; }
        .section-progress-bar { height: 100%; background: var(--red); border-radius: 2px; transition: width 0.5s; }

        /* ‚îÄ‚îÄ CHARTS ‚îÄ‚îÄ */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 14px;
            margin-bottom: 20px;
        }

        .chart-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 20px;
            box-shadow: var(--shadow);
        }

        .chart-title {
            font-family: var(--font-display);
            font-size: 13px;
            font-weight: 700;
            color: var(--text-muted);
            margin-bottom: 14px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        /* ‚îÄ‚îÄ ACTIVITY LIST ‚îÄ‚îÄ */
        .activity-list { max-height: 360px; overflow-y: auto; }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 11px 14px;
            background: var(--bg-elevated);
            border-radius: var(--radius-sm);
            margin-bottom: 6px;
            border-left: 3px solid var(--red);
            transition: all 0.2s;
        }

        .activity-item:hover { background: var(--bg-hover); transform: translateX(3px); }
        .activity-icon { font-size: 20px; min-width: 36px; text-align: center; }
        .activity-name { font-weight: 600; font-size: 13px; color: var(--text); }
        .activity-meta { font-size: 11px; color: var(--text-muted); }
        .activity-time { font-family: var(--font-mono); font-size: 11px; color: var(--text-dim); min-width: 70px; text-align: right; }

        /* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
        .table-wrapper {
            width: 100%;
            overflow-x: auto;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            max-height: 520px;
            overflow-y: auto;
        }

        .table-wrapper::-webkit-scrollbar { width: 6px; height: 6px; }
        .table-wrapper::-webkit-scrollbar-track { background: var(--bg-elevated); border-radius: 3px; }
        .table-wrapper::-webkit-scrollbar-thumb { background: var(--red-mid); border-radius: 3px; }

        table { border-collapse: separate; border-spacing: 0; width: 100%; min-width: 650px; font-size: 13px; }
        thead { position: sticky; top: 0; z-index: 10; }

        th {
            background: var(--bg-elevated);
            font-family: var(--font-mono);
            font-weight: 500;
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            padding: 12px 14px;
            border-bottom: 1px solid var(--border);
            text-align: left;
        }

        td {
            padding: 12px 14px;
            border-bottom: 1px solid rgba(0,0,0,0.04);
            color: var(--text);
            font-size: 13px;
            background: var(--bg-card);
        }

        tr:hover td { background: var(--bg-elevated); }
        tr:last-child td { border-bottom: none; }

        /* ‚îÄ‚îÄ FILTER BAR ‚îÄ‚îÄ */
        .filter-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 14px;
        }

        .filter-btn {
            padding: 6px 14px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            color: var(--text-muted);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: var(--font-body);
            display: flex;
            align-items: center;
            gap: 5px;
            box-shadow: none;
            margin-top: 0;
        }

        .filter-btn:hover { border-color: var(--red-mid); color: var(--text); transform: none; box-shadow: none; }
        .filter-btn.active { background: var(--red); border-color: var(--red); color: white; box-shadow: var(--shadow-red); }

        .filter-count {
            background: rgba(255,255,255,0.25);
            padding: 1px 6px;
            border-radius: 8px;
            font-size: 10px;
            font-family: var(--font-mono);
        }

        .filter-btn:not(.active) .filter-count { background: var(--border); color: var(--text-dim); }

        /* ‚îÄ‚îÄ SEARCH ‚îÄ‚îÄ */
        .search-wrap { position: relative; margin-bottom: 16px; }

        .search-wrap input {
            width: 100%;
            padding: 11px 16px 11px 42px;
            background: var(--bg-elevated);
            border: 1.5px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text);
            font-size: 13px;
            font-family: var(--font-body);
            transition: all 0.2s;
        }

        .search-wrap input:focus {
            outline: none;
            border-color: var(--red);
            background: var(--bg-card);
            box-shadow: 0 0 0 3px var(--red-glow);
        }

        .search-wrap input::placeholder { color: var(--text-dim); }
        .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); font-size: 15px; pointer-events: none; color: var(--text-dim); }

        .search-clear {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            font-size: 16px;
            padding: 4px;
            margin: 0;
            box-shadow: none;
            display: none;
        }
        .search-clear:hover { color: var(--red); transform: translateY(-50%); box-shadow: none; }

        /* ‚îÄ‚îÄ FORMS ‚îÄ‚îÄ */
        .form-group { display: flex; flex-direction: column; gap: 6px; }
        .form-label { font-size: 11.5px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.8px; font-family: var(--font-mono); }

        .form-input {
            padding: 11px 14px;
            background: var(--bg-elevated);
            border: 1.5px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text);
            font-size: 14px;
            font-family: var(--font-body);
            transition: all 0.2s;
            width: 100%;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--red);
            background: var(--bg-card);
            box-shadow: 0 0 0 3px var(--red-glow);
        }

        .form-input::placeholder { color: var(--text-dim); }

        /* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
        button {
            background: var(--red);
            color: white;
            border: none;
            padding: 11px 20px;
            border-radius: var(--radius-sm);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: var(--font-body);
            box-shadow: 0 2px 8px rgba(220,38,38,0.25);
            margin-top: 8px;
        }

        button:hover { background: var(--red-dark); transform: translateY(-1px); box-shadow: 0 4px 14px rgba(220,38,38,0.35); }
        button:active { transform: translateY(0); }

        .btn-ghost {
            background: transparent;
            border: 1.5px solid var(--border);
            color: var(--text-muted);
            box-shadow: none;
        }
        .btn-ghost:hover { border-color: var(--border-mid); color: var(--text); background: var(--bg-hover); box-shadow: none; }
        .btn-danger { background: #7f1d1d; }
        .btn-danger:hover { background: #991b1b; }
        .btn-sm { padding: 6px 12px; font-size: 12px; margin-top: 0; }

        /* ‚îÄ‚îÄ QR READER ‚îÄ‚îÄ */
        #qr-reader {
            width: 100%;
            max-width: 500px;
            margin: 0 auto 14px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            aspect-ratio: 1/1;
            min-height: 240px;
            background: #111;
            position: relative;
            box-shadow: var(--shadow-md);
        }

        .qr-overlay {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 78%;
            aspect-ratio: 1/1;
            border: 2px dashed rgba(220,38,38,0.8);
            border-radius: 10px;
            z-index: 20;
            pointer-events: none;
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.35);
        }

        /* ‚îÄ‚îÄ TEACHER SELECT ‚îÄ‚îÄ */
        .teacher-select-wrap {
            background: var(--bg-elevated);
            border: 1.5px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 18px;
            margin-bottom: 14px;
        }

        .teacher-select-label {
            font-size: 12px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-family: var(--font-mono);
            margin-bottom: 10px;
            display: block;
        }

        .teacher-dropdown-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }

        .teacher-dropdown {
            flex: 1;
            min-width: 200px;
            padding: 11px 36px 11px 14px;
            background: var(--bg-card);
            border: 1.5px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text);
            font-size: 14px;
            font-family: var(--font-body);
            transition: all 0.2s;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2378716c' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
        }

        .teacher-dropdown:focus { outline: none; border-color: var(--red); box-shadow: 0 0 0 3px var(--red-glow); }

        .btn-select-teacher { padding: 11px 18px; margin-top: 0; white-space: nowrap; flex-shrink: 0; }

        .teacher-hint { font-size: 11px; color: var(--text-dim); margin-top: 8px; font-family: var(--font-mono); }
        .teacher-hint.has-teacher { color: #16a34a; }

        /* ‚îÄ‚îÄ ACTIVE TEACHER BAR ‚îÄ‚îÄ */
        .scanner-active-bar {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            border: 1px solid #bbf7d0;
            border-radius: var(--radius-sm);
            padding: 14px 16px;
            margin-bottom: 14px;
            display: none;
            align-items: center;
            gap: 12px;
        }
        .scanner-active-bar.visible { display: flex; }
        .scan-active-dot { width: 10px; height: 10px; background: #16a34a; border-radius: 50%; animation: pulse-green 2s infinite; flex-shrink: 0; }
        .scan-active-info { flex: 1; }
        .scan-active-name { font-family: var(--font-display); font-weight: 700; font-size: 15px; color: #15803d; }
        .scan-active-subject { font-size: 12px; color: #16a34a; margin-top: 2px; font-weight: 600; }

        /* ‚îÄ‚îÄ SCAN POPUP ‚îÄ‚îÄ */
        #scan-display {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-card);
            border: 2px solid var(--red);
            border-radius: 20px;
            padding: 32px 28px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.18), var(--shadow-red);
            z-index: 9999;
            display: none;
            text-align: center;
            width: calc(100% - 40px);
            max-width: 380px;
            animation: popIn 0.3s cubic-bezier(0.68,-0.55,0.265,1.55);
        }

        @keyframes popIn {
            0% { transform: translate(-50%,-50%) scale(0.85); opacity: 0; }
            100% { transform: translate(-50%,-50%) scale(1); opacity: 1; }
        }

        #scan-display .icon { font-size: 48px; margin-bottom: 10px; animation: bounce 0.5s ease; }
        @keyframes bounce { 0%,100%{transform:translateY(0);}50%{transform:translateY(-8px);} }
        #scan-display strong { font-family: var(--font-display); font-size: 22px; font-weight: 800; display: block; margin: 6px 0 10px; }

        /* ‚îÄ‚îÄ VOICE BAR ‚îÄ‚îÄ */
        .voice-bar {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 14px;
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        .voice-bar label { font-size: 12px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.8px; white-space: nowrap; font-family: var(--font-mono); }
        .voice-bar select {
            flex: 1; min-width: 180px;
            padding: 8px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text);
            font-size: 13px;
            font-family: var(--font-body);
        }

        /* ‚îÄ‚îÄ PAGINATION ‚îÄ‚îÄ */
        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 16px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .page-info { font-family: var(--font-mono); font-size: 12px; color: var(--text-muted); }
        .page-btns { display: flex; gap: 6px; align-items: center; }

        .page-btn {
            padding: 7px 14px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            color: var(--text-muted);
            border-radius: var(--radius-sm);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: var(--font-body);
            margin-top: 0;
            box-shadow: none;
        }

        .page-btn:hover:not(:disabled) { border-color: var(--red-mid); color: var(--text); transform: none; }
        .page-btn:disabled { opacity: 0.35; cursor: not-allowed; }

        .page-size-select {
            padding: 7px 10px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            color: var(--text-muted);
            border-radius: var(--radius-sm);
            font-size: 12px;
            font-family: var(--font-body);
        }

        /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.4);
            z-index: 10000;
            backdrop-filter: blur(4px);
        }

        .modal {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 32px;
            max-width: 420px;
            width: calc(100% - 32px);
            z-index: 10001;
            box-shadow: var(--shadow-md);
            animation: popIn 0.3s cubic-bezier(0.68,-0.55,0.265,1.55);
        }

        .modal-icon { font-size: 48px; text-align: center; margin-bottom: 12px; }
        .modal-title { font-family: var(--font-display); font-size: 20px; font-weight: 800; text-align: center; margin-bottom: 8px; color: var(--text); }
        .modal-msg { font-size: 13px; color: var(--text-muted); text-align: center; margin-bottom: 24px; line-height: 1.6; }
        .modal-btns { display: flex; gap: 10px; justify-content: center; }
        .modal-btns button { margin-top: 0; flex: 1; max-width: 160px; }

        /* ‚îÄ‚îÄ TEACHER CARDS ‚îÄ‚îÄ */
        .teacher-card {
            background: var(--bg-elevated);
            border: 1.5px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 10px;
            transition: all 0.2s;
        }

        .teacher-card:hover { border-color: var(--red-mid); box-shadow: var(--shadow); }

        .teacher-avatar {
            width: 46px; height: 46px;
            background: linear-gradient(135deg, var(--red), var(--red-dark));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-display);
            font-weight: 800;
            font-size: 20px;
            color: white;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(220,38,38,0.25);
        }

        .teacher-info { flex: 1; min-width: 0; }
        .teacher-name { font-family: var(--font-display); font-weight: 700; font-size: 15px; color: var(--text); }
        .teacher-subject { font-size: 12px; color: var(--red); font-weight: 600; margin-top: 2px; }
        .teacher-pin { font-family: var(--font-mono); font-size: 11px; color: var(--text-dim); margin-top: 3px; }

        /* ‚îÄ‚îÄ PIN LOGIN OVERLAY ‚îÄ‚îÄ */
        #teacher-login-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.55);
            z-index: 10000;
            backdrop-filter: blur(8px);
        }

        #teacher-login-overlay.visible { display: flex; align-items: center; justify-content: center; }

        .login-box {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 40px 36px;
            max-width: 400px;
            width: calc(100% - 32px);
            text-align: center;
            box-shadow: var(--shadow-md);
            animation: popIn 0.3s cubic-bezier(0.68,-0.55,0.265,1.55);
        }

        .login-logo { font-size: 44px; margin-bottom: 14px; }
        .login-title { font-family: var(--font-display); font-size: 26px; font-weight: 800; margin-bottom: 6px; color: var(--text); }
        .login-sub { font-size: 13px; color: var(--text-muted); margin-bottom: 24px; }

        .pin-display {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .pin-dot {
            width: 16px; height: 16px;
            border-radius: 50%;
            background: var(--bg-elevated);
            border: 2px solid var(--border-mid);
            transition: all 0.2s;
        }

        .pin-dot.filled {
            background: var(--red);
            border-color: var(--red);
            box-shadow: 0 0 10px rgba(220,38,38,0.4);
        }

        .pin-pad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            max-width: 240px;
            margin: 0 auto 16px;
        }

        .pin-key {
            padding: 16px;
            background: var(--bg-elevated);
            border: 1.5px solid var(--border);
            border-radius: var(--radius-sm);
            font-family: var(--font-display);
            font-size: 20px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.15s;
            color: var(--text);
            box-shadow: none;
            margin-top: 0;
        }

        .pin-key:hover { background: var(--bg-hover); border-color: var(--border-mid); transform: scale(1.04); }
        .pin-key:active { transform: scale(0.96); }
        .pin-key.clear { color: var(--red); font-size: 14px; }
        .pin-key.enter { background: var(--red); border-color: var(--red-dark); color: white; box-shadow: var(--shadow-red); }
        .pin-key.enter:hover { background: var(--red-dark); transform: scale(1.04); }

        .pin-error { color: var(--red); font-size: 13px; font-weight: 600; margin-top: 8px; min-height: 20px; }

        /* ‚îÄ‚îÄ BADGES ‚îÄ‚îÄ */
        .badge {
            display: inline-block;
            padding: 2px 9px;
            border-radius: 8px;
            font-family: var(--font-mono);
            font-size: 11px;
            font-weight: 500;
        }

        .badge-in { background: #dcfce7; color: #15803d; }
        .badge-out { background: var(--red-soft); color: var(--red); }
        .badge-section { background: var(--bg-elevated); color: var(--text-muted); border: 1px solid var(--border); }

        /* ‚îÄ‚îÄ MISC ‚îÄ‚îÄ */
        .empty-state { text-align: center; padding: 48px 20px; color: var(--text-dim); }
        .empty-state .empty-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.35; }
        .empty-state p { font-size: 14px; }

        .success-msg {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #15803d;
            padding: 10px 14px;
            border-radius: var(--radius-sm);
            font-size: 13px;
            font-weight: 600;
            margin-top: 12px;
            display: none;
        }

        .flex-row { display: flex; gap: 10px; flex-wrap: wrap; }
        .mt-12 { margin-top: 12px; }
        #camera-status { text-align: center; font-size: 12px; color: var(--text-muted); font-family: var(--font-mono); }

        /* ‚îÄ‚îÄ PIN DELETE MODAL ‚îÄ‚îÄ */
        #pin-delete-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.55);
            z-index: 10002;
            backdrop-filter: blur(8px);
            align-items: center;
            justify-content: center;
        }
        #pin-delete-overlay.visible { display: flex; }

        .pin-delete-box {
            background: var(--bg-card);
            border: 1.5px solid var(--border-mid);
            border-radius: 24px;
            padding: 36px;
            max-width: 380px;
            width: calc(100% - 32px);
            text-align: center;
            box-shadow: var(--shadow-md);
            animation: popIn 0.3s cubic-bezier(0.68,-0.55,0.265,1.55);
        }

        .pin-delete-title { font-family: var(--font-display); font-size: 22px; font-weight: 800; color: var(--text); margin-bottom: 6px; }
        .pin-delete-sub { font-size: 13px; color: var(--text-muted); margin-bottom: 20px; }
        .pin-delete-teacher { font-family: var(--font-display); font-weight: 700; color: var(--red); font-size: 15px; margin-bottom: 20px; }

        /* ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-elevated); }
        ::-webkit-scrollbar-thumb { background: var(--red-mid); border-radius: 3px; }

        /* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
        @media (max-width: 768px) {
            body { padding: 12px; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .charts-grid { grid-template-columns: 1fr; }
            .nav-tab { font-size: 12px; padding: 8px 10px; min-width: 80px; }
            .teacher-dropdown-row { flex-direction: column; }
            .teacher-dropdown, .btn-select-teacher { width: 100%; }
        }

        @media (max-width: 420px) {
            .stats-grid { grid-template-columns: 1fr; }
            .live-clock { display: none; }
        }
    </style>
</head>
<body>

<div class="header">
        <img src="image/arklogo.png" alt="Company Logo" class="logo"> 
    <div class="header-text">
        <div class="header-title">ARK Technological Institute Education System Inc.</div>
        <div class="header-sub">J-Seven Bldg. Magallanes Cor. Granja St. Brgy. 7 Lucena City</div>
    </div>
    <div class="live-clock" id="live-clock">--:--:--</div>
</div>

<div class="context-bar" id="context-bar">
    <div class="context-dot"></div>
    <span style="font-size:13px; color:var(--text-sub);">Logged in as <span class="context-name" id="ctx-name">‚Äî</span></span>
    <span class="tag-subject" id="ctx-subject">‚Äî</span>
    <button class="context-logout" onclick="logoutTeacher()">Log Out</button>
</div>

<div class="nav-tabs">
    <button class="nav-tab active" onclick="switchTab('dashboard',this)">üìä Dashboard</button>
    <button class="nav-tab" onclick="switchTab('logs',this)">üìã Logs</button>
    <button class="nav-tab" onclick="switchTab('scanner',this)">üì∑ Scanner</button>
    <button class="nav-tab" onclick="switchTab('teachers',this)">üë©‚Äçüè´ Teachers</button>
</div>

<!-- DASHBOARD -->
<div id="dashboard-tab" class="tab-content active">
    <div class="stats-grid">
        <div class="stat-card"><div class="stat-icon">üë•</div><div class="stat-value" id="stat-total">0</div><div class="stat-label">Students Today</div></div>
        <div class="stat-card"><div class="stat-icon">‚úÖ</div><div class="stat-value" id="stat-present">0</div><div class="stat-label">Currently Present</div></div>
        <div class="stat-card"><div class="stat-icon">üè´</div><div class="stat-value" id="stat-sections">0</div><div class="stat-label">Active Sections</div></div>
        <div class="stat-card"><div class="stat-icon">üìà</div><div class="stat-value" id="stat-scans">0</div><div class="stat-label">Total Scans Today</div></div>
    </div>

    <div class="card">
        <div class="card-title"><span>üè´</span> Section Attendance Status ‚Äî Today</div>
        <div id="section-status-grid" class="section-status-grid">
            <div class="empty-state"><div class="empty-icon">üìä</div><p>No attendance data yet</p></div>
        </div>
    </div>

    <div class="charts-grid">
        <div class="chart-card"><div class="chart-title">üìà Hourly Activity</div><canvas id="hourlyChart"></canvas></div>
        <div class="chart-card"><div class="chart-title">üìÖ Weekly Attendance</div><canvas id="weeklyChart"></canvas></div>
    </div>

    <div class="card">
        <div class="card-title"><span>üïê</span> Recent Activity</div>
        <div class="activity-list" id="activity-list">
            <div class="empty-state"><div class="empty-icon">üïê</div><p>No recent activity</p></div>
        </div>
    </div>
</div>

<!-- LOGS -->
<div id="logs-tab" class="tab-content">
    <div class="card">
        <div class="card-title"><span>üìã</span> Attendance Logs</div>
        <div style="margin-bottom:14px;">
            <div class="form-label" style="margin-bottom:8px;">Filter by Subject / Teacher</div>
            <div class="filter-bar" id="subject-filter-bar">
                <button class="filter-btn active" onclick="filterBySubject(null,this)">All <span class="filter-count">0</span></button>
            </div>
        </div>
        <div style="margin-bottom:14px;">
            <div class="form-label" style="margin-bottom:8px;">Filter by Section</div>
            <div class="filter-bar" id="section-filter-bar">
                <button class="filter-btn active" onclick="filterBySection(null,this)">All <span class="filter-count">0</span></button>
            </div>
        </div>
        <div class="search-wrap">
            <span class="search-icon">üîç</span>
            <input type="text" id="search-input" placeholder="Search by name, ID, section‚Ä¶" oninput="handleSearch()">
            <button class="search-clear" id="clear-search" onclick="clearSearch()">‚úï</button>
        </div>
        <div class="table-wrapper">
            <table>
                <thead><tr><th>Student ID</th><th>Name</th><th>Section</th><th>Time In</th><th>Time Out</th><th>Date</th><th>Actions</th></tr></thead>
                <tbody id="report-body"></tbody>
            </table>
        </div>
        <div class="pagination">
            <div class="flex-row" style="align-items:center;gap:8px;">
                <span class="page-info">Show:</span>
                <select class="page-size-select" id="att-page-size" onchange="attPageSize=parseInt(this.value);attPage=1;renderAttTable(filteredPaired)">
                    <option value="20">20</option><option value="50">50</option><option value="100">100</option><option value="-1">All</option>
                </select>
            </div>
            <div class="page-btns">
                <button class="page-btn" id="att-prev" onclick="attPage--;renderAttTable(filteredPaired)" disabled>‚Üê Prev</button>
                <span class="page-info" id="att-page-info">‚Äî</span>
                <button class="page-btn" id="att-next" onclick="attPage++;renderAttTable(filteredPaired)" disabled>Next ‚Üí</button>
            </div>
        </div>
        <div class="flex-row mt-12">
            <button onclick="downloadExcel()">‚¨áÔ∏è Export Excel</button>
            <button class="btn-danger" onclick="showResetModal()">üóëÔ∏è Reset Logs</button>
        </div>
    </div>
</div>

<!-- SCANNER -->
<div id="scanner-tab" class="tab-content">
    <div class="card" style="max-width:560px;margin:0 auto;">
        <div class="card-title"><span>üì∑</span> QR Code Scanner</div>

        <div class="teacher-select-wrap">
            <span class="teacher-select-label">üë©‚Äçüè´ Select Teacher / Subject</span>
            <div class="teacher-dropdown-row">
                <select id="scanner-teacher-dropdown" class="teacher-dropdown">
                    <option value="">‚Äî No Teacher (General Attendance) ‚Äî</option>
                </select>
                <button class="btn-select-teacher" onclick="confirmSelectTeacher()">üîê Log In</button>
            </div>
            <div class="teacher-hint" id="teacher-hint">Select a teacher then click Log In to tag attendance to a subject.</div>
        </div>

        <div class="scanner-active-bar" id="scanner-active-bar">
            <div class="scan-active-dot"></div>
            <div class="scan-active-info">
                <div class="scan-active-name" id="scan-teacher-name">‚Äî</div>
                <div class="scan-active-subject" id="scan-teacher-subject">‚Äî</div>
            </div>
            <button class="btn-ghost btn-sm" onclick="clearScannerTeacher()" style="margin-top:0;">‚úï Clear</button>
        </div>

        <div class="voice-bar">
            <label>üîä Voice:</label>
            <select id="voice-select"></select>
            <button class="btn-ghost btn-sm" onclick="testVoice()" style="margin-top:0;">Test</button>
        </div>

        <div id="qr-reader"><div class="qr-overlay"></div></div>
        <p id="camera-status"></p>
    </div>
</div>

<!-- TEACHERS -->
<div id="teachers-tab" class="tab-content">
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:16px;">
        <div class="card">
            <div class="card-title"><span>‚ûï</span> Add Teacher Account</div>
            <div style="display:flex;flex-direction:column;gap:14px;">
                <div class="form-group"><label class="form-label">Full Name</label><input class="form-input" type="text" id="t-name" placeholder="e.g., Reymond Silvestre"></div>
                <div class="form-group"><label class="form-label">Subject</label><input class="form-input" type="text" id="t-subject" placeholder="e.g., Empowerment Technology"></div>
                <div class="form-group"><label class="form-label">PIN (4‚Äì6 digits)</label><input class="form-input" type="password" id="t-pin" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="6" inputmode="numeric"></div>
                <button onclick="addTeacher()">‚úÖ Add Teacher</button>
                <div class="success-msg" id="teacher-success">‚úì Teacher added successfully!</div>
            </div>
        </div>
        <div class="card">
            <div class="card-title"><span>üë©‚Äçüè´</span> Registered Teachers</div>
            <div id="teacher-list-container">
                <div class="empty-state"><div class="empty-icon">üë©‚Äçüè´</div><p>No teachers registered yet</p></div>
            </div>
        </div>
    </div>
</div>

<!-- SCAN POPUP -->
<div id="scan-display"></div>

<!-- TEACHER LOGIN OVERLAY (PIN) -->
<div id="teacher-login-overlay">
    <div class="login-box">
        <div class="login-logo">üîê</div>
        <div class="login-title">Teacher Login</div>
        <div class="login-sub" id="login-teacher-name">Enter your PIN</div>
        <div class="pin-display">
            <div class="pin-dot" id="pd0"></div><div class="pin-dot" id="pd1"></div>
            <div class="pin-dot" id="pd2"></div><div class="pin-dot" id="pd3"></div>
            <div class="pin-dot" id="pd4"></div><div class="pin-dot" id="pd5"></div>
        </div>
        <div class="pin-pad">
            <button class="pin-key" onclick="pinKey('1')">1</button><button class="pin-key" onclick="pinKey('2')">2</button><button class="pin-key" onclick="pinKey('3')">3</button>
            <button class="pin-key" onclick="pinKey('4')">4</button><button class="pin-key" onclick="pinKey('5')">5</button><button class="pin-key" onclick="pinKey('6')">6</button>
            <button class="pin-key" onclick="pinKey('7')">7</button><button class="pin-key" onclick="pinKey('8')">8</button><button class="pin-key" onclick="pinKey('9')">9</button>
            <button class="pin-key clear" onclick="pinClear()">‚å´</button><button class="pin-key" onclick="pinKey('0')">0</button><button class="pin-key enter" onclick="pinEnter()">‚úì</button>
        </div>
        <div class="pin-error" id="pin-error"></div>
        <button class="btn-ghost btn-sm" onclick="closeLoginModal()" style="margin:0 auto;display:block;">Cancel</button>
    </div>
</div>

<!-- PIN DELETE OVERLAY ‚Äî Teacher must enter their own PIN to confirm deletion -->
<div id="pin-delete-overlay">
    <div class="pin-delete-box">
        <div style="font-size:44px;margin-bottom:12px;">üóëÔ∏è</div>
        <div class="pin-delete-title">Confirm Deletion</div>
        <div class="pin-delete-sub">Enter <strong id="delete-teacher-name-label">the teacher's</strong> PIN to confirm deletion.</div>
        <div class="pin-delete-teacher" id="delete-target-label">‚Äî</div>
        <div class="pin-display">
            <div class="pin-dot" id="dpd0"></div><div class="pin-dot" id="dpd1"></div>
            <div class="pin-dot" id="dpd2"></div><div class="pin-dot" id="dpd3"></div>
            <div class="pin-dot" id="dpd4"></div><div class="pin-dot" id="dpd5"></div>
        </div>
        <div class="pin-pad">
            <button class="pin-key" onclick="deletePinKey('1')">1</button><button class="pin-key" onclick="deletePinKey('2')">2</button><button class="pin-key" onclick="deletePinKey('3')">3</button>
            <button class="pin-key" onclick="deletePinKey('4')">4</button><button class="pin-key" onclick="deletePinKey('5')">5</button><button class="pin-key" onclick="deletePinKey('6')">6</button>
            <button class="pin-key" onclick="deletePinKey('7')">7</button><button class="pin-key" onclick="deletePinKey('8')">8</button><button class="pin-key" onclick="deletePinKey('9')">9</button>
            <button class="pin-key clear" onclick="deletePinClear()">‚å´</button><button class="pin-key" onclick="deletePinKey('0')">0</button><button class="pin-key enter" onclick="deletePinEnter()">‚úì</button>
        </div>
        <div class="pin-error" id="delete-pin-error"></div>
        <button class="btn-ghost btn-sm" onclick="closeDeletePinModal()" style="margin:8px auto 0;display:block;">Cancel</button>
    </div>
</div>

<!-- CONFIRM MODAL -->
<div class="modal-overlay" id="confirm-overlay">
    <div class="modal">
        <div class="modal-icon" id="confirm-icon">‚ö†Ô∏è</div>
        <div class="modal-title" id="confirm-title">Confirm</div>
        <div class="modal-msg" id="confirm-msg">Are you sure?</div>
        <div class="modal-btns">
            <button class="btn-ghost" onclick="closeConfirm()">Cancel</button>
            <button class="btn-danger" id="confirm-ok">Confirm</button>
        </div>
    </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let allPaired = [], filteredPaired = [];
let attPage = 1, attPageSize = 20;
let currentSection = null, currentSubject = null, searchTerm = '';
let loggedInTeacher  = null;
let scannerTeacher   = null;
let pendingLoginTeacher = null, pendingLoginCallback = null, pinBuffer = '';
let hourlyChart, weeklyChart;

// Delete PIN state
let deletePinBuffer = '';
let pendingDeleteTeacherId = null;
let pendingDeleteTeacherPin = null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CLOCK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateClock() {
    document.getElementById('live-clock').textContent =
        new Date().toLocaleTimeString('en-US',{hour12:true,hour:'2-digit',minute:'2-digit',second:'2-digit'});
}
setInterval(updateClock, 1000); updateClock();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TABS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchTab(name, btn) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
    document.getElementById(name+'-tab').classList.add('active');
    if (btn) btn.classList.add('active');
    if (name === 'scanner') {
        if (!window.scannerStarted) { startScanner(); window.scannerStarted = true; }
        renderScannerDropdown();
    }
    if (name === 'dashboard') updateDashboard();
    if (name === 'logs') { renderFilters(); applyFilters(); }
    if (name === 'teachers') renderTeacherList();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TEACHERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getTeachers() {
    const local  = JSON.parse(localStorage.getItem('teachers') || '[]');
    const remote = window.remoteTeachers || [];
    const map = {};
    [...remote, ...local].forEach(t => { map[t.id] = t; });
    return Object.values(map);
}

function addTeacher() {
    const name    = document.getElementById('t-name').value.trim();
    const subject = document.getElementById('t-subject').value.trim();
    const pin     = document.getElementById('t-pin').value.trim();
    if (!name||!subject||!pin) { alert('Fill in all fields.'); return; }
    if (!/^\d{4,6}$/.test(pin)) { alert('PIN must be 4‚Äì6 digits.'); return; }
    const teacher = { id:'t_'+Date.now(), name, subject, pin };
    const local = JSON.parse(localStorage.getItem('teachers')||'[]');
    local.push(teacher);
    localStorage.setItem('teachers', JSON.stringify(local));
    if (window.saveTeacherToFirebase) window.saveTeacherToFirebase(teacher);
    document.getElementById('t-name').value='';
    document.getElementById('t-subject').value='';
    document.getElementById('t-pin').value='';
    const sm = document.getElementById('teacher-success');
    sm.style.display='block'; setTimeout(()=>sm.style.display='none',3000);
    renderTeacherList(); renderScannerDropdown(); renderFilters();
}

function renderTeacherList() {
    const teachers = getTeachers();
    const c = document.getElementById('teacher-list-container');
    if (!teachers.length) {
        c.innerHTML='<div class="empty-state"><div class="empty-icon">üë©‚Äçüè´</div><p>No teachers registered yet</p></div>';
        return;
    }
    c.innerHTML = teachers.map(t=>`
        <div class="teacher-card">
            <div class="teacher-avatar">${t.name.charAt(0)}</div>
            <div class="teacher-info">
                <div class="teacher-name">${t.name}</div>
                <div class="teacher-subject">üìö ${t.subject}</div>
                <div class="teacher-pin">PIN: ${'‚Ä¢'.repeat(t.pin.length)}</div>
            </div>
            <button class="btn-ghost btn-sm" onclick="deleteTeacher('${t.id}')"
                style="margin-top:0;color:var(--red);border-color:rgba(220,38,38,0.3);"
                title="Delete ‚Äî requires PIN">üóëÔ∏è</button>
        </div>`).join('');
}

// ‚îÄ‚îÄ PIN-PROTECTED DELETE ‚îÄ‚îÄ
function deleteTeacher(id) {
    const teacher = getTeachers().find(t => t.id === id);
    if (!teacher) return;

    // Store delete target
    pendingDeleteTeacherId  = id;
    pendingDeleteTeacherPin = teacher.pin;
    deletePinBuffer = '';

    // Update modal labels
    document.getElementById('delete-teacher-name-label').textContent = teacher.name + "'s";
    document.getElementById('delete-target-label').textContent = teacher.name + ' ‚Äî ' + teacher.subject;
    document.getElementById('delete-pin-error').textContent = '';
    updateDeletePinDisplay();

    // Show PIN delete overlay
    document.getElementById('pin-delete-overlay').classList.add('visible');
}

function closeDeletePinModal() {
    document.getElementById('pin-delete-overlay').classList.remove('visible');
    pendingDeleteTeacherId  = null;
    pendingDeleteTeacherPin = null;
    deletePinBuffer = '';
    updateDeletePinDisplay();
}

function deletePinKey(k) {
    if (deletePinBuffer.length >= 6) return;
    deletePinBuffer += k;
    updateDeletePinDisplay();
    document.getElementById('delete-pin-error').textContent = '';
}

function deletePinClear() {
    deletePinBuffer = deletePinBuffer.slice(0, -1);
    updateDeletePinDisplay();
}

async function deletePinEnter() {
    if (!pendingDeleteTeacherId || !pendingDeleteTeacherPin) return;

    if (deletePinBuffer === pendingDeleteTeacherPin) {
        // PIN matches ‚Äî proceed with deletion
        const id = pendingDeleteTeacherId;
        closeDeletePinModal();

        let local = JSON.parse(localStorage.getItem('teachers')||'[]');
        local = local.filter(t => t.id !== id);
        localStorage.setItem('teachers', JSON.stringify(local));

        const docId = window.teacherDocIds ? window.teacherDocIds[id] : null;
        if (docId && window.deleteTeacherFromFirebase) await window.deleteTeacherFromFirebase(docId);

        if (scannerTeacher && scannerTeacher.id === id) clearScannerTeacher();

        renderTeacherList();
        renderScannerDropdown();
        renderFilters();
    } else {
        document.getElementById('delete-pin-error').textContent = '‚ùå Incorrect PIN. Try again.';
        deletePinBuffer = '';
        updateDeletePinDisplay();
    }
}

function updateDeletePinDisplay() {
    for (let i = 0; i < 6; i++) {
        document.getElementById('dpd'+i).classList.toggle('filled', i < deletePinBuffer.length);
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SCANNER TEACHER DROPDOWN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderScannerDropdown() {
    const teachers = getTeachers();
    const sel = document.getElementById('scanner-teacher-dropdown');
    const currentVal = sel.value;
    sel.innerHTML = '<option value="">‚Äî No Teacher (General Attendance) ‚Äî</option>';
    teachers.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t.id;
        opt.textContent = `${t.name}  ‚Äî  ${t.subject}`;
        sel.appendChild(opt);
    });
    if (scannerTeacher && teachers.find(t=>t.id===scannerTeacher.id)) {
        sel.value = scannerTeacher.id;
    } else if (currentVal && teachers.find(t=>t.id===currentVal)) {
        sel.value = currentVal;
    }
}

function confirmSelectTeacher() {
    const sel = document.getElementById('scanner-teacher-dropdown');
    const selectedId = sel.value;

    if (!selectedId) { clearScannerTeacher(); return; }

    const teacher = getTeachers().find(t => t.id === selectedId);
    if (!teacher) { alert('Teacher not found.'); return; }

    if (scannerTeacher && scannerTeacher.id === selectedId) {
        alert(`${teacher.name} is already logged in.`);
        return;
    }

    openLoginModal(teacher, (t) => {
        scannerTeacher = t;

        document.getElementById('scanner-active-bar').classList.add('visible');
        document.getElementById('scan-teacher-name').textContent    = t.name;
        document.getElementById('scan-teacher-subject').textContent = 'üìö ' + t.subject;

        const hint = document.getElementById('teacher-hint');
        hint.textContent = `‚úì Logged in ‚Äî scans tagged to "${t.subject}"`;
        hint.className   = 'teacher-hint has-teacher';

        loggedInTeacher = t;
        document.getElementById('ctx-name').textContent    = t.name;
        document.getElementById('ctx-subject').textContent = t.subject;
        document.getElementById('context-bar').classList.add('visible');
    });
}

function clearScannerTeacher() {
    scannerTeacher = null;
    loggedInTeacher = null;
    document.getElementById('scanner-teacher-dropdown').value = '';
    document.getElementById('scanner-active-bar').classList.remove('visible');
    const hint = document.getElementById('teacher-hint');
    hint.textContent = 'Select a teacher then click Log In to tag attendance to a subject.';
    hint.className   = 'teacher-hint';
    document.getElementById('context-bar').classList.remove('visible');
}

function logoutTeacher() { clearScannerTeacher(); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PIN PAD (Login)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openLoginModal(teacher, callback) {
    pendingLoginTeacher  = teacher;
    pendingLoginCallback = callback;
    pinBuffer = '';
    document.getElementById('login-teacher-name').textContent = `${teacher.name} ‚Äî ${teacher.subject}`;
    document.getElementById('pin-error').textContent = '';
    updatePinDisplay();
    document.getElementById('teacher-login-overlay').classList.add('visible');
}

function closeLoginModal() {
    document.getElementById('teacher-login-overlay').classList.remove('visible');
    pendingLoginTeacher = null; pendingLoginCallback = null; pinBuffer = '';
    updatePinDisplay();
}

function pinKey(k)  { if(pinBuffer.length>=6)return; pinBuffer+=k; updatePinDisplay(); document.getElementById('pin-error').textContent=''; }
function pinClear() { pinBuffer=pinBuffer.slice(0,-1); updatePinDisplay(); }
function pinEnter() {
    if (!pendingLoginTeacher) return;
    if (pinBuffer === pendingLoginTeacher.pin) {
        const cb = pendingLoginCallback;
        const t  = pendingLoginTeacher;
        closeLoginModal();
        if (cb) cb(t);
    } else {
        document.getElementById('pin-error').textContent = '‚ùå Incorrect PIN. Try again.';
        pinBuffer=''; updatePinDisplay();
    }
}
function updatePinDisplay() {
    for(let i=0;i<6;i++) document.getElementById('pd'+i).classList.toggle('filled', i<pinBuffer.length);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SCANNER / QR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const html5QrCode = new Html5Qrcode("qr-reader");
let scanning = false, lastScanAt = 0;
const SCAN_COOLDOWN = 7000;
const GOOGLE_SHEET_URL = "https://script.google.com/macros/s/AKfycbzz84gbAmsUSMnvxAqYHSc1iAvL1XscsJPIX3QTX8vH234VzxlMAfDORNOvq1Hoe8w1qw/exec";

function startScanner() {
    html5QrCode.start(
        { facingMode:"environment" },
        { fps:20, qrbox:vw=>{ const s=Math.floor(Math.min(vw,vw)*0.78); return{width:s,height:s}; }, aspectRatio:1.0 },
        onScanSuccess
    ).then(()=>{
        document.getElementById('camera-status').style.color='#16a34a';
        document.getElementById('camera-status').textContent='‚óè Camera ready';
    }).catch(()=>{
        document.getElementById('camera-status').style.color='var(--red)';
        document.getElementById('camera-status').textContent='‚ö† Camera unavailable ‚Äî check permissions.';
    });
}

function onScanSuccess(text) {
    if (scanning) return;
    if (Date.now()-lastScanAt < SCAN_COOLDOWN) return;
    scanning=true; lastScanAt=Date.now();
    const parts = text.split('|').map(s=>s.trim());
    if (parts.length>=3) logAttendance(parts);
    else displayScanInfo('N/A','Invalid QR Code','Failed');
    setTimeout(()=>{ scanning=false; }, 900);
}

function formatDateOnly(d) { return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0'); }
function getTodayDate()    { return formatDateOnly(new Date()); }
function getCurrentTime()  { return new Date().toString(); }
function formatTimeOnly(str) { const d=new Date(str); return isNaN(d)?str:d.toLocaleTimeString([],{hour:'numeric',minute:'2-digit',second:'2-digit',hour12:true}); }

function getActionType(id) {
    const today = getTodayDate();
    const logs  = getCombinedLogs();
    const todayLogs = logs.filter(e=>e.studentID===id&&e.date===today);
    if (!todayLogs.length) return 'Time In';
    todayLogs.sort((a,b)=>new Date(a.time)-new Date(b.time));
    const last = todayLogs[todayLogs.length-1];
    return (!last||!last.action)?'Time In':(last.action==='Time Out'?'Time In':'Time Out');
}

function logAttendance(details) {
    const [id, name, section, contact, pictureUrl] = details;
    if (!id||!name||!section) { displayScanInfo('N/A','Invalid QR Code','Failed'); return; }

    const action    = getActionType(id);
    const timestamp = getCurrentTime();
    const date      = getTodayDate();

    const tName    = (scannerTeacher && scannerTeacher.name)    ? String(scannerTeacher.name).trim()    : '';
    const tSubject = (scannerTeacher && scannerTeacher.subject) ? String(scannerTeacher.subject).trim() : '';
    const tID      = (scannerTeacher && scannerTeacher.id)      ? String(scannerTeacher.id).trim()      : '';

    const entry = {
        studentID: id, studentName: name, studSection: section,
        studContact: contact||'N/A', studPictureUrl: pictureUrl||'N/A',
        time: timestamp, date, action,
        teacherName: tName||null, teacherSubject: tSubject||null, teacherID: tID||null
    };

    const logs = JSON.parse(localStorage.getItem('attendance')||'[]');
    logs.push(entry);
    localStorage.setItem('attendance', JSON.stringify(logs));

    if (window.saveToFirebase) window.saveToFirebase(entry);

    const payload = JSON.stringify({ studentID:id,studentName:name,studSection:section,studContact:contact||'N/A',time:timestamp,date,action,teacherName:tName,teacherSubject:tSubject,teacherID:tID });
    const xhr = new XMLHttpRequest();
    xhr.open('POST', GOOGLE_SHEET_URL, true);
    xhr.setRequestHeader('Content-Type','text/plain');
    xhr.send(payload);

    displayScanInfo(id, name, action);
    if (document.getElementById('dashboard-tab').classList.contains('active')) updateDashboard();
    if (document.getElementById('logs-tab').classList.contains('active')) { renderFilters(); applyFilters(); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SCAN POPUP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function displayScanInfo(id, name, action) {
    const el = document.getElementById('scan-display');
    const icon  = action==='Time In'?'‚û°Ô∏è':action==='Time Out'?'‚¨ÖÔ∏è':'‚ùå';
    const color = action==='Failed'?'var(--red)':'#15803d';
    const badge = action==='Failed'?'<span class="badge badge-out">Failed</span>':
                  action==='Time In'?'<span class="badge badge-in">Time In</span>':'<span class="badge badge-out">Time Out</span>';
    const subLine = scannerTeacher
        ? `<div style="font-size:12px;color:#16a34a;margin-top:4px;font-family:var(--font-mono);">üìö ${scannerTeacher.subject}</div>`
        : `<div style="font-size:12px;color:var(--text-dim);margin-top:4px;font-family:var(--font-mono);">General Attendance</div>`;
    el.innerHTML = `<div class="icon">${icon}</div>
        <strong style="color:${color};">${action==='Failed'?'Scan Failed':action+' Recorded'}</strong>
        <div style="font-size:16px;font-weight:600;color:var(--text);">${name}</div>
        <div style="color:var(--text-muted);font-size:13px;font-family:var(--font-mono);">${id}</div>
        ${subLine}<div style="margin-top:8px;">${badge}</div>`;
    el.style.display='block';
    const txt = action==='Failed'||name==='Invalid QR Code'
        ? 'Attention. Scan failed. Please try again.'
        : `${cleanNameForSpeech(name)}. ${action==='Time In'?'time in':'time out'} confirmed.`;
    speakMessage(txt);
    setTimeout(()=>el.style.display='none', 3500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VOICE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let selectedVoice=null, availableVoices=[];
function loadVoices() {
    availableVoices=speechSynthesis.getVoices();
    if(!availableVoices.length)return;
    const sel=document.getElementById('voice-select');
    sel.innerHTML='';
    const fil=availableVoices.filter(v=>v.lang.match(/fil|tl|ph/i)||v.name.match(/filipino|tagalog/i));
    const en =availableVoices.filter(v=>v.lang.startsWith('en')&&!fil.includes(v));
    const rest=availableVoices.filter(v=>!fil.includes(v)&&!en.includes(v));
    const bg=(label,voices,offset)=>{ if(!voices.length)return; const g=document.createElement('optgroup');g.label=label;voices.forEach((v,i)=>{const o=document.createElement('option');o.value=offset+i;o.textContent=`${v.name} (${v.lang})`;g.appendChild(o);});sel.appendChild(g);};
    bg('üáµüá≠ Filipino',fil,0); bg('üá∫üá∏ English',en,fil.length); bg('üåç Other',rest,fil.length+en.length);
    const saved=localStorage.getItem('preferredVoice');
    const sv=saved&&availableVoices.find(v=>v.voiceURI===saved);
    selectedVoice=sv||fil[0]||en.find(v=>v.name.includes('Google US English'))||en[0]||availableVoices[0];
    sel.selectedIndex=availableVoices.indexOf(selectedVoice);
    sel.onchange=()=>{ selectedVoice=availableVoices[parseInt(sel.value)]; localStorage.setItem('preferredVoice',selectedVoice.voiceURI); };
}
if(speechSynthesis.onvoiceschanged!==undefined)speechSynthesis.onvoiceschanged=loadVoices;
setTimeout(loadVoices,100);
function cleanNameForSpeech(n){ if(!n)return'Student'; return n.replace(/\./g,' ').trim().replace(/\s+/g,', '); }
function speakMessage(text){ speechSynthesis.cancel(); setTimeout(()=>{ const u=new SpeechSynthesisUtterance(text); if(selectedVoice)u.voice=selectedVoice; u.rate=0.9;u.pitch=1.0;u.volume=1.0; speechSynthesis.speak(u); },50); }
window.testVoice=()=>speakMessage('Magandang araw. Voice test confirmed. Good morning, this is a voice test.');

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FILTERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderFilters() {
    const logs=getCombinedLogs();
    const subjects={};
    logs.forEach(l=>{ const s=l.teacherSubject||'(No Subject)'; subjects[s]=(subjects[s]||0)+1; });
    const sfBar=document.getElementById('subject-filter-bar');
    sfBar.innerHTML=`<button class="filter-btn ${!currentSubject?'active':''}" onclick="filterBySubject(null,this)">All <span class="filter-count">${logs.length}</span></button>`;
    Object.entries(subjects).sort((a,b)=>b[1]-a[1]).forEach(([s,c])=>{ const b=document.createElement('button');b.className='filter-btn'+(currentSubject===s?' active':'');b.innerHTML=`${s} <span class="filter-count">${c}</span>`;b.onclick=()=>filterBySubject(s,b);sfBar.appendChild(b); });
    const sections={};
    logs.forEach(l=>{ const s=l.studSection||'?'; sections[s]=(sections[s]||0)+1; });
    const secBar=document.getElementById('section-filter-bar');
    secBar.innerHTML=`<button class="filter-btn ${!currentSection?'active':''}" onclick="filterBySection(null,this)">All <span class="filter-count">${logs.length}</span></button>`;
    Object.entries(sections).sort((a,b)=>b[1]-a[1]).forEach(([s,c])=>{ const b=document.createElement('button');b.className='filter-btn'+(currentSection===s?' active':'');b.innerHTML=`${s} <span class="filter-count">${c}</span>`;b.onclick=()=>filterBySection(s,b);secBar.appendChild(b); });
}
function filterBySubject(sub,btn){ currentSubject=sub; document.querySelectorAll('#subject-filter-bar .filter-btn').forEach(b=>b.classList.remove('active')); if(btn)btn.classList.add('active'); attPage=1;applyFilters(); }
function filterBySection(sec,btn){ currentSection=sec; document.querySelectorAll('#section-filter-bar .filter-btn').forEach(b=>b.classList.remove('active')); if(btn)btn.classList.add('active'); attPage=1;applyFilters(); }
function handleSearch(){ searchTerm=document.getElementById('search-input').value.toLowerCase().trim(); document.getElementById('clear-search').style.display=searchTerm?'block':'none'; attPage=1;applyFilters(); }
function clearSearch(){ document.getElementById('search-input').value=''; searchTerm=''; document.getElementById('clear-search').style.display='none'; attPage=1;applyFilters(); }
function applyFilters(){
    let filtered=getCombinedLogs();
    if(currentSubject)filtered=filtered.filter(l=>(l.teacherSubject||'(No Subject)')===currentSubject);
    if(currentSection)filtered=filtered.filter(l=>l.studSection===currentSection);
    const paired=pairEntries(filtered);
    filteredPaired=searchTerm?paired.filter(e=>(e.studentID||'').toLowerCase().includes(searchTerm)||(e.studentName||'').toLowerCase().includes(searchTerm)||(e.studSection||'').toLowerCase().includes(searchTerm)):paired;
    renderAttTable(filteredPaired);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PAIR & RENDER TABLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function pairEntries(entries) {
    const grouped={};
    entries.forEach(e=>{ const k=`${e.studentID}_${e.date}`; if(!grouped[k])grouped[k]=[]; grouped[k].push(e); });
    const pairs=[];
    Object.values(grouped).forEach(g=>{
        g.sort((a,b)=>new Date(a.time)-new Date(b.time));
        let i=0;
        while(i<g.length){
            const cur=g[i];
            const base={studentID:cur.studentID,studentName:cur.studentName,studSection:cur.studSection,date:cur.date,timeInRaw:null,timeOutRaw:null};
            if(cur.action==='Time In'){
                base.timeInRaw=cur; let out=null;
                for(let j=i+1;j<g.length;j++){if(g[j].action==='Time Out'){out=g[j];base.timeOutRaw=out;i=j;break;}}
                pairs.push({...base,timeIn:formatTimeOnly(cur.time),timeOut:out?formatTimeOnly(out.time):'-'});
            } else { base.timeOutRaw=cur; pairs.push({...base,timeIn:'-',timeOut:formatTimeOnly(cur.time)}); }
            i++;
        }
    });
    return pairs;
}
window.pairEntries=pairEntries;

function renderAttTable(paired) {
    const tbody=document.getElementById('report-body');
    if(!paired||!paired.length){ tbody.innerHTML=`<tr><td colspan="7"><div class="empty-state"><div class="empty-icon">üìã</div><p>No records found</p></div></td></tr>`; updateAttPagination(0,0);return; }
    const sorted=[...paired].sort((a,b)=>new Date(b.date+' '+(b.timeOut!=='-'?b.timeOut:b.timeIn))-new Date(a.date+' '+(a.timeOut!=='-'?a.timeOut:a.timeIn)));
    const total=sorted.length;
    const page=attPageSize>0?sorted.slice((attPage-1)*attPageSize,attPage*attPageSize):sorted;
    tbody.innerHTML='';
    page.forEach(e=>{
        const delBtns=[];
        if(e.timeInRaw){ const k=`${e.timeInRaw.studentID}_${e.timeInRaw.date}_${e.timeInRaw.time}_${e.timeInRaw.action}`; const docId=window.attendanceDocIds?window.attendanceDocIds[k]:null; delBtns.push(`<button class="btn-ghost btn-sm" style="color:var(--red);border-color:rgba(220,38,38,0.3);" onclick='confirmDeleteEntry(${JSON.stringify(e.timeInRaw).replace(/'/g,"&#39;")},${docId?`"${docId}"`:null})'>üóë In</button>`); }
        if(e.timeOutRaw){ const k=`${e.timeOutRaw.studentID}_${e.timeOutRaw.date}_${e.timeOutRaw.time}_${e.timeOutRaw.action}`; const docId=window.attendanceDocIds?window.attendanceDocIds[k]:null; delBtns.push(`<button class="btn-ghost btn-sm" style="color:var(--red);border-color:rgba(220,38,38,0.3);" onclick='confirmDeleteEntry(${JSON.stringify(e.timeOutRaw).replace(/'/g,"&#39;")},${docId?`"${docId}"`:null})'>üóë Out</button>`); }
        tbody.innerHTML+=`<tr>
            <td><span style="font-family:var(--font-mono);font-size:12px;">${e.studentID}</span></td>
            <td><strong>${e.studentName}</strong></td>
            <td><span class="badge badge-section">${e.studSection}</span></td>
            <td><span class="badge badge-in">${e.timeIn}</span></td>
            <td><span class="badge ${e.timeOut!=='-'?'badge-out':'badge-section'}">${e.timeOut}</span></td>
            <td style="font-family:var(--font-mono);font-size:12px;color:var(--text-muted);">${e.date}</td>
            <td style="display:flex;gap:6px;flex-wrap:wrap;">${delBtns.join('')}</td>
        </tr>`;
    });
    updateAttPagination(total,page.length);
}

function updateAttPagination(total,shown){
    const totalPages=attPageSize>0?Math.ceil(total/attPageSize):1;
    const info=document.getElementById('att-page-info');
    if(total===0)info.textContent='No entries';
    else if(attPageSize===-1)info.textContent=`All ${total} entries`;
    else{ const s=(attPage-1)*attPageSize+1; info.textContent=`${s}‚Äì${s+shown-1} of ${total}`; }
    document.getElementById('att-prev').disabled=attPage<=1;
    document.getElementById('att-next').disabled=attPage>=totalPages||attPageSize===-1;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DELETE ENTRY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function confirmDeleteEntry(entry,docId){
    showConfirm('üóëÔ∏è','Delete Entry?',`Delete record for ${entry.studentName}?`,async()=>{
        let logs=JSON.parse(localStorage.getItem('attendance')||'[]');
        logs=logs.filter(l=>!(l.studentID===entry.studentID&&l.date===entry.date&&l.time===entry.time&&l.action===entry.action));
        localStorage.setItem('attendance',JSON.stringify(logs));
        if(docId&&window.deleteFromFirebase)await window.deleteFromFirebase(docId);
        renderFilters();applyFilters();updateDashboard();
    });
}

function showResetModal(){
    showConfirm('‚ö†Ô∏è','Reset All Logs?','This permanently deletes ALL local attendance records. Firebase records require manual deletion.',()=>{
        localStorage.removeItem('attendance');
        window.remoteAttendanceLogs=[];
        allPaired=[];filteredPaired=[];
        renderFilters();applyFilters();updateDashboard();
    },'üóëÔ∏è Reset',true);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIRM MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let confirmCallback=null;
function showConfirm(icon,title,msg,onOk,okLabel='Confirm',danger=true){
    confirmCallback=onOk;
    document.getElementById('confirm-icon').textContent=icon;
    document.getElementById('confirm-title').textContent=title;
    document.getElementById('confirm-msg').textContent=msg;
    const btn=document.getElementById('confirm-ok');
    btn.textContent=okLabel||'Confirm';
    btn.className=danger?'btn-danger':'';
    btn.style.background=danger?'':'var(--red)';
    document.getElementById('confirm-overlay').style.display='block';
}
function closeConfirm(){ document.getElementById('confirm-overlay').style.display='none'; confirmCallback=null; }
document.getElementById('confirm-ok').addEventListener('click',()=>{ if(confirmCallback)confirmCallback(); closeConfirm(); });
document.getElementById('confirm-overlay').addEventListener('click',e=>{ if(e.target.id==='confirm-overlay')closeConfirm(); });

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateDashboard(){
    const today=getTodayDate(), logs=getCombinedLogs();
    const todayLogs=logs.filter(l=>l.date===today);
    document.getElementById('stat-total').textContent=new Set(todayLogs.map(l=>l.studentID)).size;
    document.getElementById('stat-scans').textContent=todayLogs.length;
    document.getElementById('stat-sections').textContent=new Set(todayLogs.map(l=>l.studSection)).size;
    const present=new Set();
    [...todayLogs].sort((a,b)=>new Date(a.time)-new Date(b.time)).forEach(l=>{ if(l.action==='Time In')present.add(l.studentID);else present.delete(l.studentID); });
    document.getElementById('stat-present').textContent=present.size;
    renderSectionStatusCards(todayLogs); updateHourlyChart(todayLogs); updateWeeklyChart(logs); renderRecentActivity(logs);
}

function renderSectionStatusCards(todayLogs){
    const grid=document.getElementById('section-status-grid'), sections={};
    todayLogs.forEach(l=>{ const s=l.studSection||'?'; if(!sections[s])sections[s]={totalIn:0,totalOut:0,students:new Set()}; sections[s].students.add(l.studentID); sections[s].totalIn+=l.action==='Time In'?1:0; sections[s].totalOut+=l.action==='Time Out'?1:0; });
    Object.keys(sections).forEach(s=>{ const pres=new Set(); [...todayLogs].filter(l=>l.studSection===s).sort((a,b)=>new Date(a.time)-new Date(b.time)).forEach(l=>{ if(l.action==='Time In')pres.add(l.studentID);else pres.delete(l.studentID); }); sections[s].currentlyPresent=pres.size; sections[s].total=sections[s].students.size; });
    if(!Object.keys(sections).length){ grid.innerHTML='<div class="empty-state"><div class="empty-icon">üìä</div><p>No attendance data yet today</p></div>'; return; }
    grid.innerHTML=Object.entries(sections).sort((a,b)=>b[1].total-a[1].total).map(([sec,d])=>`
        <div class="section-status-card">
            <div class="section-status-header"><div class="section-name">üìñ ${sec}</div><div class="section-count-badge">${d.total} students</div></div>
            <div class="section-stats">
                <div class="section-stat"><div class="section-stat-val in">${d.currentlyPresent}</div><div class="section-stat-lbl">Present</div></div>
                <div class="section-stat"><div class="section-stat-val out">${d.total-d.currentlyPresent}</div><div class="section-stat-lbl">Left</div></div>
                <div class="section-stat"><div class="section-stat-val" style="color:var(--text-muted);">${d.totalIn}</div><div class="section-stat-lbl">Time In</div></div>
                <div class="section-stat"><div class="section-stat-val" style="color:var(--text-muted);">${d.totalOut}</div><div class="section-stat-lbl">Time Out</div></div>
            </div>
            <div class="section-progress"><div class="section-progress-bar" style="width:${d.total>0?Math.round((d.currentlyPresent/d.total)*100):0}%"></div></div>
        </div>`).join('');
}

function updateHourlyChart(todayLogs){
    const hours=Array(24).fill(0); todayLogs.forEach(l=>{ hours[new Date(l.time).getHours()]++; });
    const ctx=document.getElementById('hourlyChart'); if(hourlyChart)hourlyChart.destroy();
    hourlyChart=new Chart(ctx,{type:'line',data:{labels:Array.from({length:24},(_,i)=>`${i}:00`),datasets:[{label:'Scans',data:hours,borderColor:'#dc2626',backgroundColor:'rgba(220,38,38,0.08)',tension:0.4,fill:true,pointRadius:3,pointBackgroundColor:'#dc2626'}]},options:{responsive:true,plugins:{legend:{labels:{color:'#78716c'}}},scales:{y:{beginAtZero:true,ticks:{color:'#78716c',stepSize:1},grid:{color:'rgba(0,0,0,0.05)'}},x:{ticks:{color:'#78716c',maxRotation:0,autoSkip:true,maxTicksLimit:12},grid:{color:'rgba(0,0,0,0.05)'}}}}});
}

function updateWeeklyChart(logs){
    const days=[],today=new Date();
    for(let i=6;i>=0;i--){const d=new Date(today);d.setDate(d.getDate()-i);days.push(formatDateOnly(d));}
    const counts=days.map(date=>new Set(logs.filter(l=>l.date===date).map(l=>l.studentID)).size);
    const ctx=document.getElementById('weeklyChart'); if(weeklyChart)weeklyChart.destroy();
    weeklyChart=new Chart(ctx,{type:'bar',data:{labels:days.map(d=>new Date(d).toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'})),datasets:[{label:'Unique Students',data:counts,backgroundColor:'rgba(220,38,38,0.75)',borderColor:'#dc2626',borderWidth:2,borderRadius:6}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{color:'#78716c',stepSize:1},grid:{color:'rgba(0,0,0,0.05)'}},x:{ticks:{color:'#78716c'},grid:{color:'rgba(0,0,0,0.05)'}}}}});
}

function renderRecentActivity(logs){
    const list=document.getElementById('activity-list');
    const sorted=[...logs].sort((a,b)=>new Date(b.time)-new Date(a.time)).slice(0,20);
    if(!sorted.length){list.innerHTML='<div class="empty-state"><div class="empty-icon">üïê</div><p>No recent activity</p></div>';return;}
    list.innerHTML=sorted.map(l=>`
        <div class="activity-item">
            <div class="activity-icon">${l.action==='Time In'?'‚û°Ô∏è':'‚¨ÖÔ∏è'}</div>
            <div style="flex:1;">
                <div class="activity-name">${l.studentName}</div>
                <div class="activity-meta">${l.studSection}${l.teacherSubject?' ¬∑ '+l.teacherSubject:''}</div>
            </div>
            <div class="activity-time">${getTimeAgo(new Date(l.time))}</div>
        </div>`).join('');
}

function getTimeAgo(date){ const s=Math.floor((Date.now()-date)/1000); if(s<60)return'Just now'; const m=Math.floor(s/60);if(m<60)return`${m}m ago`; const h=Math.floor(m/60);if(h<24)return`${h}h ago`; return`${Math.floor(h/24)}d ago`; }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXCEL EXPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function downloadExcel(){
    const logs=getCombinedLogs(); if(!logs.length){alert('No data to export.');return;}
    const paired=pairEntries(logs),wb=XLSX.utils.book_new(),byDate={};
    paired.forEach(r=>{ if(!byDate[r.date])byDate[r.date]=[]; byDate[r.date].push({Date:r.date,ID:r.studentID,Name:r.studentName,Section:r.studSection,'Time In':r.timeIn,'Time Out':r.timeOut}); });
    Object.keys(byDate).sort().reverse().forEach(date=>{ XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(byDate[date]),date.slice(5)); });
    XLSX.writeFile(wb,`ARK_Attendance_${getTodayDate()}.xlsx`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// getCombinedLogs fallback
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getCombinedLogs(){
    if (window.getCombinedLogs) return window.getCombinedLogs();
    const local=JSON.parse(localStorage.getItem('attendance')||'[]');
    const remote=window.remoteAttendanceLogs||[];
    const map={};
    [...remote,...local].forEach(e=>{ const k=`${e.studentID}_${e.date}_${e.time}_${e.action}`; if(!map[k])map[k]=e; });
    return Object.values(map);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIREBASE CALLBACKS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.onAttendanceUpdate=()=>{ const a=document.querySelector('.tab-content.active'); if(a&&a.id==='dashboard-tab')updateDashboard(); if(a&&a.id==='logs-tab'){renderFilters();applyFilters();} };
window.onTeachersUpdate=()=>{ renderTeacherList(); renderScannerDropdown(); renderFilters(); };

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded',()=>{
    setTimeout(loadVoices,200);
    window.scannerStarted=false;
    updateDashboard();
    renderTeacherList();
    renderScannerDropdown();
    setInterval(updateDashboard,30000);
});
</script>
</body>
</html>


